# Illegal Security Chip

This is super illegal even without a proper key. Please **DO NOT** use it. Otherwise $\*\*y will definitely sue you to death **IMMEDIATELY**!!!!!!!!!!!!111!!!!

-- S** FUDs

(LOL we somehow got mentioned on psxhax https://www.psxhax.com/threads/ps5tools-added-to-ps5-github-repository-by-skfu-invites-contributors.8264/)

## WTF?

This is a JavaCard applet that emulates the [A7105 security chip](https://gist.github.com/dogtopus/dae307c7773e792150990a06e79583d0) found in PS4 licensed controllers (at APDU level). It signs random challenges (nonce) sent from the host using an on-card RSA 2048 key (DS4Key). When sending the signature back, it also presents some identifying information and the public key (DS4ID) to the host.

**LIABILITY NOTICE**: This applet enables **NEITHER** controller counterfeiting nor circumventing the PS4 peripheral authentication by default. It is **NOT** intended to be used for any illegal activities. The word "Illegal" in the project name is a joke in case you didn't get it already. No keys are provided for obvious reasons. Also I am not responsible for anything you will do with this applet.

## Card Requirements

The card must satisfy all of the following in order to be able to install and run IllegalSecurityChip:

- JavaCard API >= 3.0.1 (for `Signature.ALG_RSA_SHA_256_PKCS1_PSS`)
- Properly implements `Signature.ALG_RSA_SHA_256_PKCS1_PSS` (Rare! Most random 3.0.1+ cards don't have this!)
- Approx. 512 bytes of transient memory. (Can be shrunk to just approx. 256 by merging the buffer used in `JediIdentity` with the top-level applet one)

The only card I came across that has `Signature.ALG_RSA_SHA_256_PKCS1_PSS` implemented is J3H145, which seems to run JCOP 3.x. However I believe that JCOP 2.4.2 cards like J2D081 should also work since the original A7105 security chip seem to run the exact same OS and also conveniently offers JavaCard API 3.0.1.

It should also be possible to install and run IllegalSecurityChip on a blank JCOP A710x (i.e. A710xCG). However I am unable to source such chip in manageable quantities and thus unable to test.

## Building and Usage

Simply run `ant` to build after checking out the submodules with `git submodule update --init --recursive`

To install the applet with GlobalPlatformPro, use:

```sh
gp --install IllegalSecurityChip.cap
```

### Personalization Script

IllegalSecurityChip comes with a personalization script under [utils/iscctl/](./utils/iscctl/). To use it, run

```sh
pipenv install
```

then

```sh
pipenv run ./iscctl.py --help
```

Refer to the built-in help for detailed usage.

#### Generating keys on-card

```sh
pipenv run ./iscctl.py gen-key
```

#### Importing existing DS4Key

```sh
pipenv run ./iscctl.py import-ds4key <path-to-ds4key-file>
```

#### Testing authentication

```sh
pipenv run ./iscctl.py test-auth [-c path-to-ca] [-p page-size]
```

This command should also work on A7105 security chip given proper bridge hardware between PC/SC over USB (or other protocol over other link supported by Microsoft Smart Card Base or pscslite) and NXP SCI2C.

If `page-size` is 0, iscctl will try to send/receive the whole challenge/response block in one single extended length APDU. Otherwise it will send/receive in chunks of `page-size` bytes. It is unknown whether extended length APDU is actually supported by A7105 security chip so be careful when enabling this on A7105. `page-size` is set to 0x80 by default.

You can optionally specify the Jedi CA with the `-c` parameter so that iscctl will validate the signature of DS4ID on the card as well.

#### Changing the DS4ID serial number

```sh
pipenv run ./iscctl.py set-serial <new-16-byte-serial-number>
```

Note that changing the serial number will void the signature and it needs to be re-signed before any future authentications.

#### DS4ID signing using test CA

If this is not obvious enough: Test CA is only for testing and will NOT work on real PS4.

First make sure that you generate the test CA key pair (no certificates needed, just the keys). The keys can be generated by using e.g. OpenSSL and encoded in plaintext PEM or DER format. Only RSA 2048 is supported.

To sign the DS4ID using the test CA, use

```sh
pipenv run ./iscctl.py sign-ds4id -c <your-ca-private-key>
```
